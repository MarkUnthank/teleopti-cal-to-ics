var saveAs=saveAs||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(e){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=e.document,n=function(){return e.URL||e.webkitURL||e},o=e.URL||e.webkitURL||e,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),r=!e.externalHost&&"download"in i,a=e.webkitRequestFileSystem,u=e.requestFileSystem||a||e.mozRequestFileSystem,s=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},c="application/octet-stream",d=0,l=[],f=function(){for(var e=l.length;e--;){var t=l[e];"string"==typeof t?o.revokeObjectURL(t):t.remove()}l.length=0},g=function(e,t,n){t=[].concat(t);for(var o=t.length;o--;){var i=e["on"+t[o]];if("function"==typeof i)try{i.call(e,n||e)}catch(r){s(r)}}},p=function(o,s){var f,p,E,S=this,v=o.type,R=!1,h=function(){var e=n().createObjectURL(o);return l.push(e),e},w=function(){g(S,"writestart progress write writeend".split(" "))},A=function(){(R||!f)&&(f=h(o)),p?p.location.href=f:window.open(f,"_blank"),S.readyState=S.DONE,w()},y=function(e){return function(){return S.readyState!==S.DONE?e.apply(this,arguments):void 0}},b={create:!0,exclusive:!1};if(S.readyState=S.INIT,s||(s="download"),r){f=h(o),t=e.document,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),i.href=f,i.download=s;var N=t.createEvent("MouseEvents");return N.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(N),S.readyState=S.DONE,void w()}return e.chrome&&v&&v!==c&&(E=o.slice||o.webkitSlice,o=E.call(o,0,o.size,c),R=!0),a&&"download"!==s&&(s+=".download"),(v===c||a)&&(p=e),u?(d+=o.size,void u(e.TEMPORARY,d,y(function(e){e.root.getDirectory("saved",b,y(function(e){var t=function(){e.getFile(s,b,y(function(e){e.createWriter(y(function(t){t.onwriteend=function(t){p.location.href=e.toURL(),l.push(e),S.readyState=S.DONE,g(S,"writeend",t)},t.onerror=function(){var e=t.error;e.code!==e.ABORT_ERR&&A()},"writestart progress write abort".split(" ").forEach(function(e){t["on"+e]=S["on"+e]}),t.write(o),S.abort=function(){t.abort(),S.readyState=S.DONE},S.readyState=S.WRITING}),A)}),A)};e.getFile(s,{create:!1},y(function(e){e.remove(),t()}),y(function(e){e.code===e.NOT_FOUND_ERR?t():A()}))}),A)}),A)):void A()},E=p.prototype,S=function(e,t){return new p(e,t)};return E.abort=function(){var e=this;e.readyState=e.DONE,g(e,"abort")},E.readyState=E.INIT=0,E.WRITING=1,E.DONE=2,E.error=E.onwritestart=E.onprogress=E.onwrite=E.onabort=E.onerror=E.onwriteend=null,e.addEventListener("unload",f,!1),S.unload=function(){f(),e.removeEventListener("unload",f,!1)},S}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);if("undefined"!=typeof module&&(module.exports=saveAs),"function"!=typeof Blob&&"object"!=typeof Blob||"undefined"==typeof URL)if("function"!=typeof Blob&&"object"!=typeof Blob||"undefined"==typeof webkitURL)var Blob=function(e){"use strict";var t=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||e.MSBlobBuilder||function(e){var t=function(e){return Object.prototype.toString.call(e).match(/^\[object\s(.*)\]$/)[1]},n=function(){this.data=[]},o=function(e,t,n){this.data=e,this.size=e.length,this.type=t,this.encoding=n},i=n.prototype,r=o.prototype,a=e.FileReaderSync,u=function(e){this.code=this[this.name=e]},s="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),c=s.length,d=e.URL||e.webkitURL||e,l=d.createObjectURL,f=d.revokeObjectURL,g=d,p=e.btoa,E=e.atob,S=e.ArrayBuffer,v=e.Uint8Array;for(o.fake=r.fake=!0;c--;)u.prototype[s[c]]=c+1;return d.createObjectURL||(g=e.URL={}),g.createObjectURL=function(e){var t,n=e.type;return null===n&&(n="application/octet-stream"),e instanceof o?(t="data:"+n,"base64"===e.encoding?t+";base64,"+e.data:"URI"===e.encoding?t+","+decodeURIComponent(e.data):p?t+";base64,"+p(e.data):t+","+encodeURIComponent(e.data)):l?l.call(d,e):void 0},g.revokeObjectURL=function(e){"data:"!==e.substring(0,5)&&f&&f.call(d,e)},i.append=function(e){var n=this.data;if(v&&(e instanceof S||e instanceof v)){for(var i="",r=new v(e),s=0,c=r.length;c>s;s++)i+=String.fromCharCode(r[s]);n.push(i)}else if("Blob"===t(e)||"File"===t(e)){if(!a)throw new u("NOT_READABLE_ERR");var d=new a;n.push(d.readAsBinaryString(e))}else e instanceof o?"base64"===e.encoding&&E?n.push(E(e.data)):"URI"===e.encoding?n.push(decodeURIComponent(e.data)):"raw"===e.encoding&&n.push(e.data):("string"!=typeof e&&(e+=""),n.push(unescape(encodeURIComponent(e))))},i.getBlob=function(e){return arguments.length||(e=null),new o(this.data.join(""),e,"raw")},i.toString=function(){return"[object BlobBuilder]"},r.slice=function(e,t,n){var i=arguments.length;return 3>i&&(n=null),new o(this.data.slice(e,i>1?t:this.data.length),n,this.encoding)},r.toString=function(){return"[object Blob]"},n}(e);return function(e,n){var o=n?n.type||"":"",i=new t;if(e)for(var r=0,a=e.length;a>r;r++)i.append(e[r]);return i.getBlob(o)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this);else self.URL=webkitURL;
var ics=function(){"use strict";if(navigator.userAgent.indexOf("MSIE")>-1&&-1==navigator.userAgent.indexOf("MSIE 10"))return void console.log("Unsupported Browser");var e=-1!==navigator.appVersion.indexOf("Win")?"\r\n":"\n",t=[],n=["BEGIN:VCALENDAR","VERSION:2.0"].join(e),o=e+"END:VCALENDAR";return{events:function(){return t},calendar:function(){return n+e+t.join(e)+o},addEvent:function(n,o,i,r,a){if("undefined"==typeof n||"undefined"==typeof o||"undefined"==typeof i||"undefined"==typeof r||"undefined"==typeof a)return!1;var u=new Date(r),s=new Date(a),c=("0000"+u.getFullYear().toString()).slice(-4),d=("00"+(u.getMonth()+1).toString()).slice(-2),l=("00"+u.getDate().toString()).slice(-2),f=("00"+u.getHours().toString()).slice(-2),g=("00"+u.getMinutes().toString()).slice(-2),p=("00"+u.getMinutes().toString()).slice(-2),E=("0000"+s.getFullYear().toString()).slice(-4),S=("00"+(s.getMonth()+1).toString()).slice(-2),v=("00"+s.getDate().toString()).slice(-2),R=("00"+s.getHours().toString()).slice(-2),h=("00"+s.getMinutes().toString()).slice(-2),w=("00"+s.getMinutes().toString()).slice(-2),A="",y="";g+p+h+w!=0&&(A="T"+f+g+p,y="T"+R+h+w);var b=c+d+l+A,N=E+S+v+y,T=["BEGIN:VEVENT","CLASS:PUBLIC","DESCRIPTION:"+o,"DTSTART;VALUE=DATE:"+b,"DTEND;VALUE=DATE:"+N,"LOCATION:"+i,"SUMMARY;LANGUAGE=en-us:"+n,"TRANSP:TRANSPARENT","END:VEVENT"].join(e);return t.push(T),T},download:function(i,r){if(t.length<1)return!1;r="undefined"!=typeof r?r:".ics",i="undefined"!=typeof i?i:"calendar";var a,u=n+e+t.join(e)+o;if(-1===navigator.userAgent.indexOf("MSIE 10"))a=new Blob([u]);else{var s=new BlobBuilder;s.append(u),a=s.getBlob("text/x-vCalendar;charset="+document.characterSet)}return saveAs(a,i+r),u}}},ics=function(e,t){"use strict";if(navigator.userAgent.indexOf("MSIE")>-1&&-1==navigator.userAgent.indexOf("MSIE 10"))return void console.log("Unsupported Browser");"undefined"==typeof e&&(e="default"),"undefined"==typeof t&&(t="Calendar");var n=-1!==navigator.appVersion.indexOf("Win")?"\r\n":"\n",o=[],i=["BEGIN:VCALENDAR","PRODID:"+t,"VERSION:2.0"].join(n),r=n+"END:VCALENDAR";return{events:function(){return o},calendar:function(){return i+n+o.join(n)+r},addEvent:function(t,i,r,a,u){if("undefined"==typeof t||"undefined"==typeof i||"undefined"==typeof r||"undefined"==typeof a||"undefined"==typeof u)return!1;var s=new Date(a),c=new Date(u),d=new Date,l=("0000"+s.getFullYear().toString()).slice(-4),f=("00"+(s.getMonth()+1).toString()).slice(-2),g=("00"+s.getDate().toString()).slice(-2),p=("00"+s.getHours().toString()).slice(-2),E=("00"+s.getMinutes().toString()).slice(-2),S=("00"+s.getMinutes().toString()).slice(-2),v=("0000"+c.getFullYear().toString()).slice(-4),R=("00"+(c.getMonth()+1).toString()).slice(-2),h=("00"+c.getDate().toString()).slice(-2),w=("00"+c.getHours().toString()).slice(-2),A=("00"+c.getMinutes().toString()).slice(-2),y=("00"+c.getMinutes().toString()).slice(-2),b=("0000"+d.getFullYear().toString()).slice(-4),N=("00"+(d.getMonth()+1).toString()).slice(-2),T=("00"+d.getDate().toString()).slice(-2),D=("00"+d.getHours().toString()).slice(-2),O=("00"+d.getMinutes().toString()).slice(-2),I=("00"+d.getMinutes().toString()).slice(-2),B="",L="";p+E+S+w+A+y!=0&&(B="T"+p+E+S,L="T"+w+A+y);var U="T"+D+O+I,M=l+f+g+B,m=v+R+h+L,C=b+N+T+U,j=["BEGIN:VEVENT","UID:"+o.length+"@"+e,"CLASS:PUBLIC","DESCRIPTION:"+i,"DTSTAMP;VALUE=DATE-TIME:"+C,"DTSTART;VALUE=DATE-TIME:"+M,"DTEND;VALUE=DATE-TIME:"+m,"LOCATION:"+r,"SUMMARY;LANGUAGE=en-us:"+t,"TRANSP:TRANSPARENT","END:VEVENT"].join(n);return o.push(j),j},download:function(e,t){if(o.length<1)return!1;t="undefined"!=typeof t?t:".ics",e="undefined"!=typeof e?e:"calendar";var a,u=i+n+o.join(n)+r;if(-1===navigator.userAgent.indexOf("MSIE 10"))a=new Blob([u]);else{var s=new BlobBuilder;s.append(u),a=s.getBlob("text/x-vCalendar;charset="+document.characterSet)}return saveAs(a,e+t),u},build:function(){if(o.length<1)return!1;var e=i+n+o.join(n)+r;return e}}};


var CALENDAR = ics($('#CurrentMonth').val().replace(/\s/g, ''));
var $calCell = $( '.cal-cell' );

if ( $( 'ul.navbar-nav.submenu' ).find( '.active' ).has( '#month-schedule-month' ).length ) {
  $calCell.each(function(){
    // Don't process a day off/absence or out-month dates
    if ( $( this ).has( 'div.dayoff' ).length || $( this ).has( 'div.absence' ).length || $( this ).has( 'div.cal-day-outmonth' ).length ) {} 
    else {
      // Get the shift Date
      var shiftDate = $( this ).data( 'cal-date' );

      // Get the shift time
      if ( $( this ).find( 'div.shift' ) ) {
        var $shift = $( this ).find( 'div.shift' );
        var shiftName = $shift.find( '[data-bind="text: shiftName"]' ).text();
        var shiftTime = $shift.find( '[data-bind="text: shiftTimeSpan"]' ).text().split( '-' );
        var shiftStart = shiftTime[0];
        var shiftEnd = shiftTime[1];

        if ( shiftName && shiftStart && shiftEnd ) {
          // Subject, Description, Location, Begin, End
          CALENDAR.addEvent( shiftName + ' Shift' , '' , '' , shiftDate + " " + shiftStart , shiftDate + shiftEnd );
        }
        
      }
    }
  });

  if ( confirm( "File ready. Would you like to download it?") ){
    var downloadName = $('#CurrentMonth').val() + ' Work Schedule';
    CALENDAR.download( downloadName );
  }
} else {
  confirm("Please switch to Month view");
}